# =====================================================================
# 11_interfaces.ir.yml
# =====================================================================
# CSA (Collaborative Sensing Agent) - Interface Registry
#
# Purpose:
#   - Canonical definitions of all data types, schemas, and channels
#     exchanged between modules defined in 10_architecture.ir.yml.
#   - Implements the mathematical objects defined in 02_onn_math_spec.md.
#
# Principles:
#   - Framework-agnostic (no ROS msg dependencies).
#   - Identifiers are sacred (must be used exactly in code).
# =====================================================================

metadata:
  system_name: CSA (Collaborative Sensing Agent)
  version: 0.1.0
  description: >
    Defines the data contracts for the Trinity of Operators (SEGO, LOGOS, IMAGO)
    and the ORTSF control fabric.
  last_updated_by: Gemini_Interface_Architect
  related_specs:
    - "10_architecture.ir.yml"
    - "02_onn_math_spec.md"

# -------------------------------------------------------------------
# 1. DATA SCHEMAS
# -------------------------------------------------------------------

data_schemas:

  # --- Core Mathematical Tensors (from 02_onn_math_spec.md) ---

  - id: SemanticNode
    description: >
      A single node S_i on the Semantic Manifold.
      Represents an entity's existence via 3 fiber components.
    fields:
      - name: node_id
        type: uint64
        description: "Unique persistent identifier for this anchor."
      - name: bound_tensor
        type: float32_array[16]
        description: "B_i: Encodes physical occupancy and collision boundaries."
      - name: form_tensor
        type: float32_array[32]
        description: "F_i: Encodes visual identity and invariant appearance."
      - name: intent_tensor
        type: float32_array[16]
        description: "I_i: Encodes functional affordances and task relevance."
      - name: uncertainty
        type: float32
        description: "u_i: Node's uncertainty (>=0), damps updates."

  - id: SemanticEdge
    description: >
      A relationship E_ij between two nodes.
    fields:
      - name: source_id
        type: uint64
        description: "ID of the source node S_i."
      - name: target_id
        type: uint64
        description: "ID of the target node S_j."
      - name: relation_embedding
        type: float32_array[dynamic]
        description: "r_ij: Continuous vector representing the nature of the relation."
      - name: weight
        type: float32
        description: "w_ij: Connection stiffness (0.0 to inf)."
      - name: probability
        type: float32
        description: "p_ij: Existence confidence, evidence for gating."
      - name: gate
        type: float32
        description: "g_ij: Computed gate value in [0, 1] for this relation."

  # --- Stream Payloads ---

  - id: SensorObservation
    description: >
      Z_i: The raw evidence package from HAL.
      Aggregates vision, depth, and proprioception.
    fields:
      - name: timestamp_ns
        type: uint64
        description: "Acquisition time in nanoseconds."
      - name: frame_id
        type: string
        description: "Reference coordinate frame (e.g., 'robot_base')."
      - name: rgb_images
        type: list<image_buffer>
        description: "List of raw camera images."
      - name: depth_maps
        type: list<image_buffer>
        description: "Aligned depth maps."
      - name: joint_state
        type: JointState
        description: "Current robot configuration (q, q_dot)."

  - id: JointState
    description: "Standard proprioceptive state."
    fields:
      - name: position
        type: float32_array
        description: "Joint angles (radians) or positions (meters)."
      - name: velocity
        type: float32_array
        description: "Joint velocities."
      - name: effort
        type: float32_array
        description: "Joint torques/forces."

  - id: RawSemanticGraph
    description: >
      G_raw: The output of SEGO. A graph that may contain topological
      contradictions before the solver runs.
    fields:
      - name: timestamp_ns
        type: uint64
      - name: nodes
        type: list<SemanticNode>
        description: "Projected nodes from current observations."
      - name: edge_candidates
        type: list<SemanticEdge>
        description: "Proposed edges based on geometric proximity."

  - id: StabilizedGraph
    description: >
      G_valid: The output of LOGOS. A graph where S and E satisfy
      the manifold constraints C.
    fields:
      - name: timestamp_ns
        type: uint64
      - name: nodes
        type: list<SemanticNode>
        description: "Nodes with adjusted embedding values."
      - name: edges
        type: list<SemanticEdge>
        description: "Validated edges (low-weight edges pruned)."
      - name: global_energy
        type: float32
        description: "Residual energy of the system (lower is better)."
      # CPL_008: Verification fields
      - name: is_valid
        type: bool
        description: "True if solver converged, False otherwise."
      - name: iterations_used
        type: uint32
        description: "Number of iterations performed."

  - id: ReasoningTrace
    description: >
      R_trace: The output of IMAGO. A continuous signal defining the
      intended flow of the system state.
    fields:
      - name: timestamp_ns
        type: uint64
      - name: target_state
        type: list<SemanticNode>
        description: "S*: The desired future state of relevant nodes."
      - name: trajectory_coeffs
        type: float32_array[dynamic]
        description: "Polynomial/Spline coefficients defining the path manifold."
      - name: curvature
        type: float32
        description: "Forman-Ricci curvature scalar of the active cluster."
      - name: valid_until_ns
        type: uint64
        description: "Expiration time for this trace (for safety)."

  - id: ActuatorCommand
    description: >
      u: The output of ORTSF. Computed control actions.
    fields:
      - name: timestamp_ns
        type: uint64
      - name: mode
        type: enum
        description: "POSITION | VELOCITY | TORQUE | IMPEDANCE"
      - name: command_values
        type: float32_array
        description: "Values corresponding to the mode (e.g., torques)."

  # --- Configuration & Control ---

  - id: MissionGoal
    description: >
      High-level intent provided by the application layer.
    fields:
      - name: goal_id
        type: string
        description: "Unique ID for this mission."
      - name: verb
        type: string
        description: "e.g., 'POUR', 'GRASP', 'MONITOR'."
      - name: target_node_id
        type: uint64
        description: "ID of the primary object of interest."
      - name: constraints
        type: dictionary
        description: "Task-specific constraints (e.g., 'keep_upright')."

  - id: ConstraintConfig
    description: >
      Parameters for the LOGOS solver.
    fields:
      - name: weights
        type: dictionary<string, float>
        description: "Importance weights for different constraint types."
      - name: max_iterations
        type: uint32
        description: "Budget for the solver loop."
      - name: learning_rate
        type: float32
        description: "Eta: Step size for gradient descent."

  # --- Relation Embedding & ONN Core ---

  - id: EdgeKey
    description: "Canonical edge identifier."
    fields:
      - name: source_id
        type: uint64
        description: "Source node ID."
      - name: target_id
        type: uint64
        description: "Target node ID."

  - id: EdgeEmbeddingState
    description: "Edge embedding observations x_obs for candidate edges."
    fields:
      - name: timestamp_ns
        type: uint64
        description: "Observation time."
      - name: edge_keys
        type: list<EdgeKey>
        description: "Edge identifiers."
      - name: embeddings
        type: list<float32_array[32]>
        description: "Edge embeddings (x_obs) per edge."
      - name: weights
        type: float32_array
        description: "Optional edge weights (confidence/prior)."

  - id: CycleBasis
    description: "Cycle constraint basis for edge embeddings."
    fields:
      - name: cycle_matrix
        type: float32_array[dynamic, dynamic]
        description: "Cycle matrix C (q x m)."
      - name: tau
        type: float32_array[dynamic]
        description: "Target cycle values (tau)."
      - name: edge_keys
        type: list<EdgeKey>
        description: "Edge ordering for C columns."

  - id: ONNSolverConfig
    description: "Brain-inspired residual dynamics hyperparameters."
    fields:
      - name: beta_obs
        type: float32
        description: "Weight for observation residual (r_obs)."
      - name: beta_cons
        type: float32
        description: "Weight for consistency residual (r_cons)."
      - name: step_size
        type: float32
        description: "Gradient step size (eta)."
      - name: steps
        type: uint32
        description: "Inner loop steps (K)."
      - name: projection_alpha
        type: float32
        description: "Relaxed projection strength (alpha)."
      - name: gate_threshold
        type: float32
        description: "Threshold for conflict-based gating."
      - name: uncertainty_damping
        type: float32
        description: "Factor for how much uncertainty reduces step size."
      - name: lambda_ricci
        type: float32
        description: "Weight for Ricci regularization."
      - name: lambda_smooth
        type: float32
        description: "Weight for smoothness penalty."
      - name: lambda_var
        type: float32
        description: "Weight for anti-collapse variance penalty."

  # --- ES Training & Evaluation ---

  - id: ESConfig
    description: "Evolutionary Strategy configuration (CMA-ES)."
    fields:
      - name: algorithm
        type: string
        description: "ES algorithm name (e.g., CMA-ES)."
      - name: population_size
        type: uint32
        description: "Number of candidates per generation."
      - name: sigma
        type: float32
        description: "Search distribution scale."
      - name: elite_fraction
        type: float32
        description: "Fraction of elites kept."
      - name: seed
        type: uint32
        description: "Random seed for reproducibility."
      - name: max_generations
        type: uint32
        description: "Max generations to run."
      - name: parameter_bounds
        type: dictionary<string, list<float32>>
        description: "Parameter bounds [min, max] for ES meta-parameters (beta_obs, beta_cons, eta, gate_threshold)."

  - id: EvalMetrics
    description: "Aggregated evaluation metrics for ONN/ES."
    fields:
      - name: violation_mean
        type: float32
        description: "Average constraint violation."
      - name: violation_max
        type: float32
        description: "Maximum constraint violation."
      - name: drift_mean
        type: float32
        description: "Average drift from observations."
      - name: ricci_energy
        type: float32
        description: "Sum of Ricci curvature squared."
      - name: smoothness
        type: float32
        description: "Average step-to-step change magnitude."
      - name: latency_mean
        type: float32
        description: "Average recovery latency after events."
      - name: collapse_score
        type: float32
        description: "Embedding variance proxy (anti-collapse)."
      - name: contradiction_rate
        type: float32
        description: "Optional probe-based contradiction rate."

  - id: GateReport
    description: "Gate evaluation result."
    fields:
      - name: passed
        type: bool
        description: "Overall gate pass/fail."
      - name: failed_gates
        type: list<string>
        description: "List of failed gate IDs."
      - name: metrics
        type: EvalMetrics
        description: "Metrics used for gating."

  - id: ESReport
    description: "ES training progress report."
    fields:
      - name: generation
        type: uint32
        description: "Generation index."
      - name: best_fitness
        type: float32
        description: "Best fitness value."
      - name: best_params
        type: dictionary<string, float32>
        description: "Best parameter vector (theta)."
      - name: metrics
        type: EvalMetrics
        description: "Metrics for the best candidate."

# -------------------------------------------------------------------
# 2. CHANNELS
# -------------------------------------------------------------------
# Defines the logical pipes connecting the modules.
# -------------------------------------------------------------------

channels:

  # --- Hardware <-> System ---

  - id: sensor_observation_stream
    schema_id: SensorObservation
    description: "High-bandwidth stream of raw sensor data."
    producer: hal_sensor_bridge
    consumers:
      - sego_gauge_anchor
      - ortsf_fabric_controller

  - id: actuator_command_stream
    schema_id: ActuatorCommand
    description: "Real-time motor commands."
    producer: ortsf_fabric_controller
    consumers:
      - hal_actuator_bridge

  # --- Internal Reasoning Pipeline ---

  - id: raw_graph_stream
    schema_id: RawSemanticGraph
    description: "Unstable graph proposals from Perception."
    producer: sego_gauge_anchor
    consumers:
      - logos_consensus_solver

  - id: edge_embedding_stream
    schema_id: EdgeEmbeddingState
    description: "Edge embedding observations x_obs for candidate edges."
    producer: onn_relation_encoder
    consumers:
      - logos_consensus_solver

  - id: stabilized_graph_stream
    schema_id: StabilizedGraph
    description: "Topologically valid graphs from the Solver."
    producer: logos_consensus_solver
    consumers:
      - imago_intent_planner
      - app_mission_control

  - id: reasoning_trace_stream
    schema_id: ReasoningTrace
    description: "Continuous intent flow for control."
    producer: imago_intent_planner
    consumers:
      - ortsf_fabric_controller

  # --- Application / Config ---

  - id: mission_goal_stream
    schema_id: MissionGoal
    description: "User intent updates."
    producer: app_mission_control
    consumers:
      - imago_intent_planner

  - id: constraint_config_update
    schema_id: ConstraintConfig
    description: "Dynamic updates to solver parameters."
    producer: app_mission_control
    consumers:
      - logos_consensus_solver

  - id: onn_solver_config_stream
    schema_id: ONNSolverConfig
    description: "Projectionâ€“Consensus solver hyperparameter updates."
    producer: es_trainer
    consumers:
      - logos_consensus_solver

  - id: eval_metrics_stream
    schema_id: EvalMetrics
    description: "Aggregated evaluation metrics for ES and validation."
    producer: eval_gate
    consumers:
      - es_trainer

  - id: gate_report_stream
    schema_id: GateReport
    description: "Pass/fail gate results."
    producer: eval_gate
    consumers:
      - app_mission_control

  - id: es_report_stream
    schema_id: ESReport
    description: "ES training reports."
    producer: es_trainer
    consumers:
      - app_mission_control

# -------------------------------------------------------------------
# 3. FRAMES
# -------------------------------------------------------------------

frames:
  - id: world
    description: "Fixed global origin (if SLAM is available)."
  - id: robot_base
    description: "Mobile base or mounting point of the arm."
  - id: sensor_optical
    description: "Camera optical frame."
